# C++库文件 ： 动态库/静态库

在C++中，库是预编译好的代码的集合，可以被多个程序重复使用。库的存在可以让我们不必每次都重新编译这部分代码，同时也方便了代码的复用和分发。C++主要使用两种类型的库：静态库和动态库。

## 1. 什么是库？

库是一系列函数和类的集合，它们被编译成二进制形式，并可以被其他程序链接和调用。使用库的好处包括：

*   **模块化**：将代码组织成独立的模块，易于维护和复用。
*   **代码重用**：多个应用程序可以共享同一份库代码。
*   **编译效率**：库是预编译好的，可以加快整体的编译速度。

## 2. 静态库 (Static Libraries)

静态库在程序编译时会被完全复制到目标可执行文件中。

*   **文件扩展名**：在Linux/macOS上通常是 `.a` (archive)，在Windows上是 `.lib`。
*   **链接方式**：编译时静态链接。链接器在编译时将库中的代码完整地拷贝到最终的可执行文件中。
*   **优点**：
    *   **部署简单**：由于所有代码都在一个可执行文件中，发布时不需要附带库文件。
    *   **运行速度快**：函数调用是直接的，没有运行时查找的开销。
*   **缺点**：
    *   **可执行文件体积大**：如果多个程序都使用了同一个静态库，每个程序都会包含一份库的副本，导致磁盘空间浪费。
    *   **更新困难**：如果库更新了，所有使用了该库的程序都需要重新编译。

### 创建静态库 (Linux/g++)

假设我们有 `mylib.h` 和 `mylib.cpp` 两个文件。

1.  **编译源文件为目标文件 (`.o`)**
    ```bash
    g++ -c mylib.cpp -o mylib.o
    ```
2.  **使用 `ar` (archiver) 工具创建静态库**
    ```bash
    ar rcs libmylib.a mylib.o
    ```
    *   `r`: 将文件插入静态库中。
    *   `c`: 如果库不存在，则创建它。
    *   `s`: 创建目标文件索引，这在链接时可以加快速度。

### 使用静态库 (Linux/g++)

假设我们有一个主程序 `main.cpp` 需要使用 `libmylib.a`。

```bash
g++ main.cpp -L. -lmylib -o myapp
```
*   `-L.`: 指定库文件的搜索路径，`.` 表示当前目录。
*   `-lmylib`: 链接名为 `mylib` 的库。编译器会自动寻找 `libmylib.a`。

---

## 3. 动态库 (Dynamic Libraries)

动态库在程序运行时才被加载到内存中。可执行文件中只包含对库的引用，而不是库的完整代码。

*   **文件扩展名**：在Linux上是 `.so` (shared object)，在macOS上是 `.dylib`，在Windows上是 `.dll` (dynamic-link library)。
*   **链接方式**：运行时动态链接。程序启动时或在需要时，操作系统会加载库文件到内存中。
*   **优点**：
    *   **节省内存和磁盘空间**：多个程序可以共享内存中同一份库的副本。
    *   **更新方便**：更新库文件后，所有使用该库的程序在下次运行时都会自动使用新版本的库，无需重新编译程序本身。
*   **缺点**：
    *   **部署复杂**：发布程序时必须附带所依赖的动态库文件。
    *   **版本兼容性问题**：如果更新的库与程序不兼容，可能导致程序无法运行（即"DLL地狱"）。

### 创建动态库 (Linux/g++)

1.  **编译源文件为位置无关代码 (PIC) 的目标文件**
    ```bash
    g++ -fPIC -c mylib.cpp -o mylib.o
    ```
    *   `-fPIC`: 生成位置无关代码 (Position-Independent Code)，这是创建动态库所必需的。
2.  **使用 `g++` 创建动态库**
    ```bash
    g++ -shared -o libmylib.so mylib.o
    ```
    *   `-shared`: 生成共享库。

### 使用动态库 (Linux/g++)

1.  **编译并链接主程序**
    ```bash
    g++ main.cpp -L. -lmylib -o myapp
    ```
    这和链接静态库的命令一样。

2.  **运行程序**
    直接运行 `./myapp` 可能会报错，提示找不到 `libmylib.so`。因为操作系统不知道去哪里找这个库。有几种方法解决：
    *   **使用 `LD_LIBRARY_PATH` 环境变量** (临时)
        ```bash
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:.
        ./myapp
        ```
    *   **将库文件安装到标准路径**：如 `/usr/lib` 或 `/usr/local/lib`。
    *   **配置 `/etc/ld.so.conf`**：将库所在目录添加到这个文件中，并运行 `ldconfig`。

## 4. 总结对比

| 特性 | 静态库 | 动态库 |
| :--- | :--- | :--- |
| **链接时间** | 编译时 | 运行时 |
| **文件大小** | 生成的可执行文件较大 | 生成的可执行文件较小 |
| **内存占用** | 每个进程一份副本，占用内存 | 多进程共享一份副本，节省内存 |
| **更新部署** | 需重新编译整个程序 | 只需替换库文件，无需重新编译程序 |
| **依赖性** | 无外部依赖 | 运行时依赖库文件必须存在 |
| **扩展名** | `.a`, `.lib` | `.so`, `.dylib`, `.dll` |

选择哪种库取决于你的需求。对于小型、自包含的应用程序，静态库可能更简单。对于大型系统或需要模块化和灵活更新的场景，动态库是更好的选择。

---

## 5. 实际演示项目

本目录包含了两个完整的演示项目，展示了如何使用 CMake 构建多文件的静态库和动态库：

### 静态库演示 (`static_lib/`)

**功能特性：**
- 数学工具库：基础运算、幂运算、阶乘、质数判断
- 字符串工具库：大小写转换、反转、分割、连接、字符串检查

**文件结构：**
```
static_lib/
├── math_utils.h          # 数学工具头文件
├── math_utils.cpp        # 数学工具实现
├── string_utils.h        # 字符串工具头文件
├── string_utils.cpp      # 字符串工具实现
├── main.cpp              # 主程序，演示库的使用
├── CMakeLists.txt        # CMake构建配置
├── build.sh              # 构建脚本
└── README.md             # 详细说明文档
```

**构建和运行：**
```bash
cd static_lib
chmod +x build.sh
./build.sh
```

### 动态库演示 (`dynamic_lib/`)

**功能特性：**
- 计算器工具库：基础运算、高级数学函数、三角函数
- 几何工具库：平面几何、立体几何计算

**文件结构：**
```
dynamic_lib/
├── calculator.h          # 计算器工具头文件
├── calculator.cpp        # 计算器工具实现
├── geometry.h            # 几何工具头文件
├── geometry.cpp          # 几何工具实现
├── main.cpp              # 主程序，演示库的使用
├── CMakeLists.txt        # CMake构建配置
├── build.sh              # 构建脚本
└── README.md             # 详细说明文档
```

**构建和运行：**
```bash
cd dynamic_lib
chmod +x build.sh
./build.sh
```

### CMake 构建系统特点

两个演示项目都使用了现代的 CMake 构建系统，具有以下特点：

1. **多文件编译**：每个库都包含多个源文件，展示了如何组织复杂的库结构
2. **自动依赖管理**：CMake 自动处理头文件依赖和链接关系
3. **跨平台支持**：支持 Windows、Linux、macOS 等不同平台
4. **符号导出控制**：动态库演示了如何正确导出符号
5. **构建脚本**：提供了便捷的构建脚本，一键完成配置、编译和测试

### 学习要点

通过这两个演示项目，你可以学习到：

1. **库的设计模式**：如何将功能模块化并组织成库
2. **CMake 最佳实践**：现代 C++ 项目的构建配置
3. **符号可见性**：动态库中符号导出的正确方法
4. **多文件项目结构**：如何组织包含多个源文件的库
5. **构建自动化**：使用脚本自动化构建过程

这些演示项目为学习 C++ 库开发提供了完整的实践示例。
